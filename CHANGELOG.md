# 开发日志

## v1.3 (2025-02-15)

### 数据处理优化

#### 1. 列头换行符处理
- 支持带换行符的列名（如 `总评\n成绩`、`平时\n(30%)`）
- 自动清理换行符后进行匹配

#### 2. 多列并排数据边界检测优化
- 使用"班级"列位置确定每组数据的边界
- 修复班级列在学号列之前时无法识别的问题
- 正确处理各组数据互不干扰

#### 3. 学号验证增强
- 排除包含小数点的值（如 `0.0282`）
- 避免误识别统计数据为学生数据

#### 4. 移除冗余提示
- 移除"检测到多组并排学生数据"的提示信息

### 文档更新

#### 1. macOS兼容性说明
- 明确说明应用仅支持 Apple Silicon 芯片（M1/M2/M3/M4）
- Intel Mac 用户需通过 Python 运行

#### 2. macOS打开方法扩充
- 新增 Option + 右键打开方法（推荐）
- 新增 `xattr -r -d com.apple.quarantine` 命令
- 新增"不支持该文件"问题的解答

---

## v1.2 (2025-02-15)

### 文件覆盖处理

#### 1. 新增文件覆盖确认对话框
- 当输出目录存在同名文件时，弹出三选项对话框：
  - 「是」覆盖原文件
  - 「否」自动重命名（添加 `_1`, `_2` 等后缀）
  - 「取消」跳过此文件
- 跳过的文件在结果中显示为 `⏭ 文件名: 已跳过（文件已存在）`
- 完成消息显示"成功: X, 失败: Y, 跳过: Z"

### UI优化

#### 1. 新增"清空"输出目录按钮
- 输出目录区域新增"清空"按钮
- 点击后恢复为"未选择（将使用源文件所在目录）"

#### 2. 新增"恢复默认"配置按钮
- 配置参数区域右上角新增"恢复默认"按钮
- 一键恢复所有参数为默认值：50/30/20, 30/70, 0.6

#### 3. 进度条自动隐藏
- 处理完成后，进度条延迟1.5秒自动隐藏
- 避免进度条一直显示影响界面美观

#### 4. 全部跳过提示
- 修复：当所有文件都被跳过时，现在会正确弹出提示"所有 X 个文件均已跳过"

### 数据处理优化

#### 1. 班级识别增强
- 新增从工作表名称提取班级信息（如 `9007851-0001_音乐2212` → `音乐2212`）
- 新增从文件名提取班级信息（如 `软件工程2301_成绩.xlsx` → `软件工程2301`）
- 班级识别优先级：单元格内容 > 工作表名称 > 文件名 > 列数据

#### 2. 学号识别放宽
- 学号验证条件放宽：长度≥5，数字占比≥80%
- 支持包含少量字母的学号格式

#### 3. 多列并排数据处理
- 支持同一工作表中包含多组并排的学生数据
- 自动识别并正确处理每组数据的班级列
- 多列检测信息从警告改为汇总提示

#### 4. 列头搜索范围扩大
- 列头搜索范围从前15行扩大到前50行
- 支持列头不在表格顶部的成绩单格式

#### 5. 总成绩列识别增强
- 新增支持"总分"列名
- 匹配模式：总成绩、总评成绩、总分、成绩、总评

#### 6. 错误提示优化
- 缺少列时明确指出缺少的具体列名（如"缺少列「总成绩」"）
- 不再显示模糊的"未找到完整的成绩列组合"

#### 7. 代码优化
- 将辅助函数 `is_valid_student_id` 和 `is_empty` 移至循环外部，提高性能
- 移除未使用的变量 `successful_sheets`

---

## v1.1 (2025-02-15)

### 界面优化

#### 1. 新增功能按钮
- **说明书按钮**: 右上角添加"📖 说明书"按钮，点击打开同目录下的说明书.txt
- **打开输出目录按钮**: 生成报告按钮旁新增"📂 打开输出目录"绿色按钮
  - 若刚生成了文件，打开目录并选中第一个生成的文件
  - 若未生成文件，打开选择的输出目录或输入文件所在目录

#### 2. 字体与可读性改进
- 文件列表字体改为 Microsoft YaHei（微软雅黑），字号从 12 加大到 14
- 所有灰色提示文字从 `gray` 改为深灰色 `#555555`，提高 Windows 上的可读性
- 警告信息颜色从 `orange` 改为深橙色 `#CC7000`

### 数据处理优化

#### 1. 班级识别更灵活
- 支持多种位置：顶部、底部、列数据
- 支持多种格式：
  - `行政班：XXX` / `行政班:XXX` / `行政班 XXX`
  - `班级：XXX` / `班级:XXX` / `班级 XXX`
  - 列头为"班级"或"行政班"，从每行数据提取
- 班级信息变为可选：缺失时显示警告，班级列留空，程序继续运行

#### 2. Sheet1 处理改进
- 如果文件只有一个工作表（即使名为 Sheet1），也会正常处理
- 只有当文件有多个工作表时，才跳过名为 Sheet1 的空白工作表

### 图表优化

#### 1. X轴标签间隔动态调整
- 根据学生数量动态计算标签间隔：`tick_skip = max(1, num_students // 10)`
- 效果：无论学生数量多少，X轴大约保持显示10个标签
  - 10人以下：显示全部标签
  - 50人：每5个显示一个
  - 100人：每10个显示一个

### 跨平台支持
- 打开目录功能支持 Windows (`explorer`)、macOS (`open`) 和 Linux (`xdg-open`)
- 打开说明书功能支持三大平台

---

## v1.0 (2025-02-15)

### 新增：桌面应用程序 (achievement_report_app)

#### 1. CustomTkinter 图形界面
- **框架**: 使用 CustomTkinter 构建现代化桌面应用
- **功能**:
  - 文件选择：支持多文件批量处理，带序号显示
  - 输出目录：可选择自定义输出位置
  - 配置参数：可视化配置目标占比、成绩占比、期望值
  - 进度显示：实时进度条和状态信息
  - 结果展示：成功/警告/失败分色显示

#### 2. 完善的错误处理
- **配置验证**（实时）:
  - 目标占比之和必须为100%
  - 成绩占比之和必须为100%
  - 达成度期望值必须在0-1之间
  - 非数字输入检测
- **文件验证**:
  - 文件类型检查（仅支持.xlsx/.xls）
  - 文件存在性检查
  - 输出目录权限检查
- **数据处理**:
  - 文件读取错误（损坏/被占用）
  - 工作表跳过警告（缺少必需列/行政班信息）
  - 文件保存错误

#### 3. 打包发布
- **macOS**: 生成 .app 应用包
- **Windows**: 提供打包脚本 build_app.py
- **文档**: 说明书.txt、Windows打包说明.txt

#### 4. 项目结构
```
achievement_report_app/
├── main.py                 # 主程序入口
├── core/
│   ├── __init__.py
│   ├── config.py          # 配置参数类
│   └── processor.py       # 核心处理逻辑
├── build_app.py           # 打包脚本
├── requirements.txt       # 依赖列表
└── 达成度报告生成器/
    ├── 达成度报告生成器.app  # macOS应用
    ├── 说明书.txt
    └── Windows打包说明.txt
```

---

## 2025-02-15 (凌晨)

### 新增功能

#### 1. 缺考/缓考学生处理
- **需求**: 若学生成绩中存在"缺考"、"缓考"等状态，或成绩为空，需在达成度报告中保留其基本信息并标注状态
- **实现**:
  - 修改 `extract_students_from_grades()` 函数，添加 `status` 字段标记特殊状态
  - 识别关键词：缺考、缓考、作弊、取消、免修、旷考
  - 特殊状态学生：保留序号、班级、学号、姓名；H列显示状态；其他成绩和达成度列留空
  - AC-AE列（期望值）对所有学生填入，保证图表红色虚线完整
  - 统计页占比公式使用 `COUNT()` 统计有效学生数
- **修复**: 解决 `pd.isna()` 导致的 "The truth value of a DataFrame is ambiguous" 警告

#### 2. 动态列识别功能
- **需求**: 支持不同结构的成绩单文件
- **实现**:
  - 动态搜索"行政班"信息，使用正则表达式提取班级名称（去除冗余信息如括号内容、授课教师等）
  - 动态搜索列头行（包含"学号"和"姓名"的行）
  - 支持多种列名变体：
    - 期末成绩: 期末成绩、期末、期末考试
    - 平时成绩: 平时成绩、平时、平时分
    - 总成绩: 总成绩、总评成绩、成绩、总评（优先级从高到低）

#### 3. 批处理功能
- **命令**: `python process_achievement_data.py --batch`
- **输入目录**: `./成绩单/`
- **输出目录**: `./达成度数据输出/`
- **输出命名**: `原文件名_达成度报告.xlsx`

### 图表优化

#### 1. X轴配置
- 标签每隔5显示（0, 5, 10...）
- 最大值超过学生总数（如77名学生，显示到80）
- 使用 `tickLblSkip = 5` 和 `tickMarkSkip = 5`

#### 2. 线条样式
- 散点：蓝色圆形标记点
- 平均值线：鲜绿色(#00FF00)双线+系统点线 (`cmpd='dbl'`, `prstDash='sysDot'`)
- 期望值线：红色(#FF0000)双线+系统点线

#### 3. 网格线
- X轴和Y轴均添加网格线
- 颜色：浅灰色(#C0C0C0)，模拟60%透明度

#### 4. 统计页图表
- 数据源修正为百分比列（D, F, H）而非人数列（C, E, G）
- Y轴范围：0%-100%
- 移除图例
- 图表位置：第一个A列、第二个I列、第三个P列

### 样式修复

#### 1. 边框修复
- AG1合并单元格边框（需同时设置AG1和AG2）
- 统计页G1:H1、E1:F1、C1:D1合并单元格边框

#### 2. 图表位置
- 右侧两个图表左侧与AV列对齐（`col_gap = 12`）

### 代码清理

#### 1. 移除未使用的导入
- ScatterChart, Reference (顶层), DataPoint, DataLabelList, Scaling, copy, re

#### 2. 移除未使用的参数
- `create_charts()` 函数的 `num_students` 参数
- `setup_statistics_sheet()` 函数的 `num_students` 参数

### Git管理

#### 1. .gitignore 配置
```
.~*           # Excel临时文件
~$*           # Excel临时文件
__pycache__/  # Python缓存
达成度数据输出.xlsx
test_*.xlsx
```

#### 2. 备份文件
- `process_achievement_data_template_version.py`: 初始依赖模板的版本备份

---

## 版本说明

### 当前版本特性
- 完全独立运行，不依赖模板文件
- 支持批处理多个成绩单文件
- 动态识别成绩单列结构
- 正确处理缺考/缓考等特殊状态学生
- 生成包含图表的完整达成度报告

### 配置参数 (代码顶部)
```python
RATIO_1 = 50              # 目标一占比 (%)
RATIO_2 = 30              # 目标二占比 (%)
RATIO_3 = 20              # 目标三占比 (%)
REGULAR_SCORE_RATIO = 30  # 平时成绩占比 (%)
FINAL_SCORE_RATIO = 70    # 期末成绩占比 (%)
ACHIEVEMENT_EXPECTATION = 0.6  # 达成度期望值
```
